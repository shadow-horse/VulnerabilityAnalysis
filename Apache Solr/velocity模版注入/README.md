## Apache Solr Velocity模版注入远程命令执行漏洞验证

### 1.背景

2019年10月31日，国内安全媒体纰漏，国外的安全研究员S00pY在GitHub发布了Apache Solr Velocity模版注入远程命令执行的poc，经验POC真实有效，定级为严重；  

国内媒体的预警： https://mp.weixin.qq.com/s/RWG7nxwCMtlyPnookXlaLA  

### 2. 漏洞详情

1. 当攻击者可以直接访问Solr控制台时，可以通过发送类似/节点名/config的POST请求对该节点的配置文件做更改。  
2. Apache Solr默认集成VelocityResponseWriter插件，在该插件的初始化参数中的   params.resource.loader.enabled这个选项是用来控制是否允许参数资源加载器在Solr请求参数中指定模版，默认设置是false。   
3. 当设置params.resource.loader.enabled为true时，将允许用户通过设置请求中的参数来指定相关资源的加载，这也就意味着攻击者可以通过构造一个具有威胁的攻击请求，在服务器上进行命令执行。



### 3. 漏洞验证 

### 1. 下载solr-6.6.0，运行开启服务

	/Users/snow/Files/solr-6.6.0/bin
	bogon:bin snow$ ls
	init.d                  post                    solr.in.cmd
	install_solr_service.sh solr                    solr.in.sh
	oom_solr.sh             solr.cmd
	bogon:bin snow$ ./solr -e dih
	
	Starting up Solr on port 8983 using command:
	"/Users/snow/Files/solr-6.6.0/bin/solr" start -p 8983 -s "/Users/snow/Files/solr-6.6.0/example/example-DIH/solr"
	
	Waiting up to 180 seconds to see Solr running on port 8983 [\]
	Started Solr server on port 8983 (pid=24330). Happy searching!

	Solr dih example launched successfully. Direct your Web browser to http://localhost:8983/solr to visit the Solr Admin UI
	bogon:bin snow$
	
访问服务：http://localhost:8983/solr/#/   

